## 视频直播的流程
#### 一、采集视频、音频

音频采样数据：一般都是PCM格式
视频采样数据：一般是YUV或RGB格式
采集到的原始音频的体积是非常大的，需要经过压缩技术处理来提高传输效率。

#### 二、视频处理(美颜、水印)
视频处理原理：因为视频最终也是通过GPU，一帧一帧渲染到屏幕上的，所以我们可以利用OpenGL ES，对视频帧进行各种加工，从而视频各种不同的效果。现在的各种美颜和视频添加特效的app都是利用GPUImage这个框架实现的。GPUImage是一个基于OpenGL ES的一个强大的图像/视频处理框架，封装好了各种滤镜，同时也可以自定义滤镜，其本身内置了多达120多种常见的滤镜效果。


#### 三、视频编码框架
1. 视频编码框架
  FFmpeg是一个跨平台的开源视频框架，能实现如视频编码、解码、转码、串流、播放等丰富的功能。其支持的视频格式以及播放协议非常丰富，几乎包含了所有音视频编解码、封装格式以及播放协议。
2. 视频编码技术
  视频压缩编码标准：对视频进行压缩(视频编码)或者解压缩(视频解码)的编码技术，比如MPEG、H.264。主要作用是将视频像素数据压缩成视频码流，从而降低视频的数据量。
    * MPEG：一种视频压缩方式，它采用了帧间压缩，仅存储连续帧之间有差别的地方，从而达到较大的压缩比。
    * H.264/AVC：一种视频压缩方式，采用事先预测和与MPEG中的P-B帧一样的帧预测方法压缩，它可以根据需要产生适合网络情况传输的视频流，还有更高的压缩比，有更好的图像质量。
      注意：
      1. 如果是从单个画面清晰度比较，MPEG4有优势；从动作连贯性上的清晰度，H.264有优势
      2. 由于264的算法更加复杂，程序实现繁琐，运行它需要更多的处理器和内存资源。因此运行H.264264对系统要求是比较高
      3. 由于264的实现更加灵活，它把一些实现留给了厂商自己去实现，虽然这样给实现带来了很多好处，但是不同产品之间互通成了很大的问题，造成了通过A公司的编码器编出的数据，必须通过A公司的解码器去解这样尴尬的事情
    * H.265/HEVC :一种视频压缩方式,基于H.264，保留原来的某些技术，同时对一些相关的技术加以改进，以改善码流、编码质量、延时和算法复杂度之间的关系，达到最优化设置。
    * H.265 是一种更为高效的编码标准，能够在同等画质效果下将内容的体积压缩得更小，传输时更快更省带宽
  几个特殊帧：
  * I帧 :(关键帧)保留一副完整的画面，解码时只需要本帧数据就可以完成（因为包含完整画面）
  * P帧 :(差别帧)保留这一帧跟之前帧的差别，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终画面。（P帧没有完整画面数据，只有与前一帧的画面差别的数据）
  * B帧 :(双向差别帧)保留的是本帧与前后帧的差别，解码B帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时CPU会比较累
  几种压缩方式：
  * 帧内压缩：当压缩一帧图像时，仅考虑本帧的数据而不考虑相邻帧之间的冗余信息,帧内一般采用有损压缩算法
  * 帧间压缩：时间压缩（Temporal compression），它通过比较时间轴上不同帧之间的数据进行压缩。帧间压缩一般是无损的
  * muxing(合成)：将视频流、音频流甚至是字幕流封装到一个文件中( 容器格式（FLV，TS） )，作为一个信号进行传输。
3. 音频编码技术
  AAC，mp3 ：这些属于音频编码技术,压缩音频用
4. 码率控制
  多码率 :观众所处的网络情况是非常复杂的，有可能是WiFi，有可能4G、3G、甚至2G，那么怎么满足多方需求呢？多搞几条线路，根据当前网络环境自定义码率。列如：常常看见视频播放软件中的1024，720，高清，标清，流畅等，指的就是各种码率。
5. 视频封装格式
  * TS:一种流媒体封装格式，流媒体封装有一个好处，就是不需要加载索引再播放，大大减少了首次载入的延迟。如果片子比较长，mp4文件的索引相当大，影响用户体验。为什么要用TS？这是因为两个TS片段可以无缝拼接，播放器能连续播放。
  * FLV:一种流媒体封装格式,由于它形成的文件极小、加载速度极快，使得网络观看视频文件成为可能,因此FLV格式成为了当今主流视频格式

#### 四、推流
1. 数据传输框架
  librtmp：用来传输RTMP协议格式个数据
2. 流媒体数据传输协议
  * RTMP：实时消息传输协议,Adobe Systems公司为Flash播放器和服务器之间音频、视频和数据传输开发的开放协议，因为是开放协议所以都可以使用了。
  * RTMP协议用于对象、视频、音频的传输，这个协议建立在TCP协议或者轮询HTTP协议之上
  * RTMP协议就像一个用来装数据包的容器，这些数据可以是FLV中的视音频数据。一个单一的连接可以通过不同的通道传输多路网络流，这些通道中的chunk(消息包)都是按照固定大小的包传输的

#### 五、流媒体服务器
1. 常用服务器
  SRS：一款国人开发的优秀开源流媒体服务器系统
  BMS: 也是一款流媒体服务器系统，但不开源，是SRS的商业版，比SRS功能更多
  nginx: 免费开源web服务器，常用来配置流媒体服务器。
2. 数据分发
  CDN:即内容分发网络,将网站的内容发布到最接近用户的网络”边缘”，使用户可以就近取得所需的内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度.
  CDN工作原理：
    1. 上传流媒体数据到服务器（源站）
    2. 源站存储流媒体数据
    3. 客户端播放流媒体，向CDN请求编码后的流媒体数据
    4. CDN的服务器响应请求，若节点上没有该流媒体数据存在，则向源站继续请求流媒体数据；若节点上已经缓存了该视频文件，则跳到第6步。
    5. 源站响应CDN的请求，将流媒体分发到相应的CDN节点上
    6. CDN将流媒体数据发送到客户端

#### 六、拉流
直播协议选择：即时性要求较高或有互动需求的，可以采用RTMP、RTSP。对于有回放或跨平台需求的，推荐使用HLS。

#### 七、解码
1. 解封装
  demuxing（分离）：从视频流、音频流，字幕流合成的文件(容器格式（FLV，TS）)中， 分解出视频、音频或字幕，各自进行解码
2. 音频编码框架
  fdk_aac：音频编码解码框架，PCM音频数据和AAC音频数据互转
3. 解码介绍
  硬解码：用GPU来解码，减少CPU运算　优点：播放流畅、低功耗，解码速度快　 缺点：兼容不好
  软解码：用CPU来解码  优点：兼容好　　 缺点：加大CPU负担，耗电增加、没有硬解码流畅，解码速度相对慢
