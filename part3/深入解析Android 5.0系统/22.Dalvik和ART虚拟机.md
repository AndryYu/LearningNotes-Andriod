# 第二十二章  Dalvik和ART虚拟机

## 1.Dalvik虚拟机简介
Dalvik虚拟机最大的特点是基于寄存器，而不是像JVM基于栈。Android也使用新开发的Dex文件格式来代替Java虚拟机的CLASS文件。Dalvik虚拟机架构图，主要由5大部分组成：
* 类装载子系统：负责把Java类从文件装载进内存。
* 垃圾回收子系统：负责定时回收进程内不再使用的对象。
* 运行数据区：用于存储Java程序创建的各种对象。
* 执行引擎：负责执行Java代码。
* 本地方法区：提供虚拟机需要的本地库。

即时编译JIT也称为运行时编译，是一种在运行时将字节码翻译成机器码的技术。JIT技术的要点是把翻译好的机器码缓存起来，而不是每次都解释，以节约时间。早期的JIT编译器以方法为单位进行编译。但一个方法中有些分支执行频率高，有些可能很少执行，这就是所谓的热路径和冷路径。后来JIT编译器发展出了通过“路径”编译的技术。JIT编译器会记录方法内分支的执行频率，只对热路径编译，以节约时间和空间。Android使用的JIT默认是按“路径”方式进行编译的。


## 2.Dalvik的启动和初始化
Dalvik虚拟机在Zygote进程中启动和初始化，AndroidRuntime.cpp的startVm()函数开始启动Dalvik。




## 3.Dalvik字节码的执行过程





## 4.Dalvik的内存管理机制
Dalvik虚拟机中需要实现垃圾回收的机制，必须自行维护和管理堆来进行内存分配和回收。


## 5.ART模式简介
从系统的执行角度看，ART和Dalvik的区别表现在两个地方：
* 一是在安装应用执行优化的时候，Dalvik模式下执行的是dexopt程序，而ART模式下执行的是dex2oat程序。通过dex2oat程序编译后得到的是elf格式的可执行文件。
* 二是在运行应用时，Dalvik模式下系统为应用进程链接的是libdvm.so，而ART模式下链接的是libart.so.
